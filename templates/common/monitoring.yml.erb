<%= comment_box "Monitoring Configuration for #{app_name}" %>
<%= comment_box "Generated by Goico - Rails Application Packager" %>

monitoring:
  app_name: <%= app_name %>
  enabled: true
  generated_at: <%= Time.now.utc.iso8601 %>

# Health checks
health_checks:
  application:
    name: "Application Responsive"
    command: "curl -f http://localhost:<%= @analysis[:infrastructure][:webserver] == :standalone ? 3000 : 80 %>/health"
    interval: 30s
    timeout: 10s

  database:
    name: "Database Connection"
    command: "cd <%= app_install_path %> && bundle exec rails runner 'ActiveRecord::Base.connection.execute(\"SELECT 1\")'"
    interval: 60s
    timeout: 15s

  <% if @analysis[:infrastructure][:cache_store] == :redis %>
  redis:
    name: "Redis Connection"
    command: "redis-cli ping"
    interval: 60s
    timeout: 5s
  <% end %>

  disk_space:
    name: "Disk Space"
    command: "df -h / | awk 'NR==2 {if ($5 > 90) exit 1}'"
    interval: 300s

# Metrics collection
metrics:
  application:
    port: 9394  # Prometheus metrics port
    path: /metrics
    collect:
      - http_requests
      - response_time
      - memory_usage
      - active_connections

  database:
    enabled: true
    <% case @analysis[:database] %>
    <% when :postgresql %>
    exporter: postgres_exporter
    port: 9187
    <% when :mysql %>
    exporter: mysqld_exporter
    port: 9104
    <% end %>

  <% if @analysis[:infrastructure][:cache_store] == :redis %>
  redis:
    exporter: redis_exporter
    port: 9121
  <% end %>

# Alerting
alerts:
  critical:
    - "Application down for 2 minutes"
    - "Database connection failed"
    - "Disk space above 90%"

  warning:
    - "Response time above 2 seconds"
    - "Memory usage above 80%"
    - "Disk space above 80%"

# Dashboard configuration
dashboard:
  type: grafana
  port: 3000
  datasource: prometheus

  panels:
    - application_health
    - response_times
    - throughput
    - error_rates
    - resource_usage