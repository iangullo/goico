#!/bin/bash
# SSL Setup for <%= app_name %>
# Generated by Goico

set -e

DOMAIN="<%= domain %>"
EMAIL="<%= email %>"
WEBSERVER="<%= webserver %>"

echo "Setting up SSL for $DOMAIN..."

# Check if Certbot is available
if ! command -v certbot &> /dev/null; then
    echo "Installing Certbot..."
    <% case package_manager %>
    <% when 'apt' %>
    apt-get update
    apt-get install -y certbot python3-certbot-nginx
    <% when 'yum' || 'dnf' %>
    yum install -y certbot python3-certbot-nginx
    <% when 'brew' %>
    brew install certbot
    <% else %>
    echo "Please install Certbot manually for your system"
    exit 1
    <% end %>
fi

# Stop webserver temporarily
echo "Stopping webserver..."
<% case webserver %>
<% when 'nginx' %>
systemctl stop nginx || true
<% when 'apache' %>
systemctl stop apache2 || systemctl stop httpd || true
<% end %>

# Obtain SSL certificate
echo "Obtaining SSL certificate for $DOMAIN..."
case "$WEBSERVER" in
    nginx)
        certbot certonly --standalone -d "$DOMAIN" --non-interactive --agree-tos --email "$EMAIL"
        ;;
    apache)
        certbot certonly --standalone -d "$DOMAIN" --non-interactive --agree-tos --email "$EMAIL"
        ;;
    *)
        echo "Unsupported webserver for SSL: $WEBSERVER"
        exit 1
        ;;
esac

# Update webserver configuration for SSL
echo "Configuring $WEBSERVER for SSL..."
<% case webserver %>
<% when 'nginx' %>
cp <%= config_path %>/nginx_ssl.conf /etc/nginx/sites-available/<%= app_name %>
<% when 'apache' %>
cp <%= config_path %>/apache_ssl.conf /etc/apache2/sites-available/<%= app_name %>.conf
a2enmod ssl
a2ensite <%= app_name %>
<% end %>

# Restart webserver
echo "Restarting webserver..."
<% case webserver %>
<% when 'nginx' %>
systemctl start nginx
systemctl enable nginx
<% when 'apache' %>
systemctl start apache2 || systemctl start httpd
systemctl enable apache2 || systemctl enable httpd
<% end %>

# Setup auto-renewal
echo "Setting up SSL certificate auto-renewal..."
(crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -

echo "SSL setup completed successfully!"
echo "Your application is now available at: https://$DOMAIN"