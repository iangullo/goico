#!/bin/bash
# Database setup for <%= app_name %>
# Generated by Goico

set -e

echo "Setting up <%= database_type %> database for <%= app_name %>..."

<% case database_type %>
<% when 'postgresql' %>
# PostgreSQL setup
sudo -u postgres createuser --createdb --login <%= app_name %> 2>/dev/null || true
sudo -u postgres createdb -O <%= app_name %> <%= app_name %>_production 2>/dev/null || true
echo "PostgreSQL database '<%= app_name %>_production' created"

<% when 'mysql' %>
# MySQL setup
mysql -e "CREATE USER IF NOT EXISTS '<%= app_name %>'@'localhost' IDENTIFIED BY '<%= mysql_password %>';" 2>/dev/null || true
mysql -e "CREATE DATABASE IF NOT EXISTS <%= app_name %>_production;" 2>/dev/null || true
mysql -e "GRANT ALL PRIVILEGES ON <%= app_name %>_production.* TO '<%= app_name %>'@'localhost';" 2>/dev/null || true
mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true
echo "MySQL database '<%= app_name %>_production' created"

<% when 'sqlite' %>
# SQLite setup (just ensure directory exists)
mkdir -p /var/lib/<%= app_name %>
touch /var/lib/<%= app_name %>/production.sqlite3
chown <%= user %>:<%= group %> /var/lib/<%= app_name %>/production.sqlite3
echo "SQLite database created at /var/lib/<%= app_name %>/production.sqlite3"

<% else %>
echo "Unknown database type: <%= database_type %>"
exit 1
<% end %>

# Run migrations if requested
<% if run_migrations %>
echo "Running database migrations..."
cd <%= app_path %>
export RAILS_ENV=production
bundle exec rails db:migrate
<% if run_seeds %>bundle exec rails db:seed<% end %>
<% end %>

echo "Database setup completed for <%= app_name %>"